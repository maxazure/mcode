# MaxAgent 项目指令

这些规则会在本项目内的所有对话/子 agent 中生效，用于降低 token 消耗并提高工具使用效率。

## 代码库探索必须委派给 explore 子 agent

当用户的问题需要理解代码库结构、定位关键文件、或可能涉及**阅读多个文件**（典型关键词：项目/代码库/结构/哪里/修复/改造/检查/解释/运行/报错等）时：

1. **主 agent 第一件事必须调用**：
   `subagent(agent_type="explore", root="目标目录", task=..., context=...)`
   - `root` 必须尽量**窄**：如果用户问题里出现了具体路径/子目录名，`root` 就取该路径（或其最近父目录）。
   - **禁止**在目标明确时传 `root="."` 或项目根目录；只有用户明确要求“全项目/全仓库探索”时才允许。
   - 示例：用户说“检查 demo 中的多人贪吃蛇游戏”，应传 `root="demo/multiplayer_snake"`（或至少 `root="demo"`）。
2. explore 子 agent 的任务是：
   - 自动列出目录概览/树状统计
   - 估算各文件 token 并按上下文预算分批读入
   - 对每批文件做总结（map），再合并成总体概览（reduce）
   - 给出**主 agent 下一步应一次性 read_file 的关键文件清单（<=10个）**，并说明理由
   - 给出项目类型和主要源代码类型例如(*.vb, *.py, *.cs)
3. **主 agent 仅按该清单批量 read_file** 后再继续分析/修改。
   - 如果 explore 输出里包含 `Recommended Files for Main Agent` 的 JSON（`{"recommended_files": [...]}`），**必须在同一轮里一次性对列表内所有文件做 `read_file`**，不要拆分多轮。

> 目标：让“找文件/摸结构/选阅读集”在一个新上下文里完成，避免主上下文反复搜索和重复读文件。

## 避免重复工具调用

- 如果已经读过/搜过同一文件或同一 pattern，且文件未被修改，**禁止再次用相同参数调用** `read_file/list_files/grep/glob/search_code`。
- 只有在文件被 `edit/write_file` 修改后，或需要不同范围/不同 pattern 时才允许重新读取/搜索。
- 若同一路径被多次 `read_file`（例如修改后为了获取最新内容），应确保旧版本不会在上下文中长期保留导致重复占用；系统会尽量只保留最新一次完整 `read_file` 内容。

## 避免重复修改同一文件

- 同一文件的改动应尽量在**一次** `edit` 或 `write_file(overwrite=true)` 中完成；除非出现新信息/测试结果/上一轮失败需要补充，否则禁止对同一文件多次 `edit`。
- 如果预计一个文件需要多处改动，先在脑中/草稿里整合最终版本，再一次性提交补丁；不要边想边改导致碎片化修改。
- 若同一文件需要多处独立替换，优先用 `edit(edits=[...])` 在一个请求里批量完成，减少多轮 `edit` 和上下文膨胀。
- 变更跨度大、需要替换大片内容时，优先使用 `write_file(overwrite=true)` 全量重写（前提：已 `read_file`），避免连续多次 `edit`。
- 若确实需要二次修改（例如上次 `edit` 失败或运行结果要求调整），必须先 `read_file` 重新获取最新内容，再进行下一次 `edit`。

## 长命令链请委派给 shell 子 agent

当需要执行多步命令行调试（安装依赖、跑测试、起服务、环境排查）时，优先：

`subagent(agent_type="shell", task="...", context="...")`

具体规则：
- **只要预期需要 2 次及以上 `run_command`**（例如：先跑测试再排查报错），就不要在主线程直接跑；改用 shell 子 agent。
- 如果一次 `run_command` 已经失败且还需要继续排查，立刻转交给 shell 子 agent。

shell 子 agent 只返回**命令列表 + 关键结果 + 建议下一步**，主 agent 不要在主上下文里反复 run_command。
