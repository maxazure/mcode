上下文汇总整理功能（实现说明）

本功能用于解决长时间对话导致上下文过长、接近模型窗口上限的问题。它参考了 `docs/上下文汇总工具.md` 的业务流程，并在 MaxAgent 中落地为“滚动摘要 + 长期记忆卡片”机制。

---

## 1. 触发条件

MaxAgent 在每次调用模型前都会通过 `ContextManager.needs_compression()` 估算当前上下文 token 使用率。当满足以下任一条件时触发汇总压缩：

- 上下文使用率超过阈值（默认 80%）
- 或者剩余 headroom 低于预留（默认保留 10%/至少 2000 tokens 给下一轮）

触发后不再简单丢弃旧消息，而是：

1. 保留 system prompt
2. 保留最近 `min_messages_to_keep` 条消息（默认 4）
3. 将其余较老的对话交给 LLM 生成结构化摘要
4. 用摘要替换掉旧历史

---

## 2. 摘要内容与滚动更新

摘要由 `ContextSummarizer` 生成，输出为一个“可直接放入 prompt 的短上下文”。摘要消息会以以下形式插入到历史里：

- role: `assistant`
- name: `context_summary`
- content 以 `## Context Summary` 开头

当再次触发汇总时，旧的 `context_summary` 会与本次需要压缩的旧消息一起重新汇总，形成新的滚动摘要，避免摘要无限叠加。

摘要结构（由模型按提示生成）：

- 当前目标 / 需求（Goal）
- 背景（Background）
- 关键信息 / 事实（Key Facts）
- 约束（Constraints）
- 决策（Decisions）
- TODO / 下一步（TODOs / Next Steps）
- 重要代码 / 命令片段（Important Snippets）

---

## 3. 长期记忆卡片

每次生成摘要时，模型还会抽取可被未来检索的重要信息，形成“记忆卡片（MemoryCard）”，并持久化到磁盘。

- 存储位置：`<project_root>/.maxagent/memory.json`
- 数据格式：JSON 数组，每项包含：
  - `content`: 记忆内容（一句话）
  - `type`: goal / decision / constraint / todo / code / fact
  - `tags`: 主题关键词
  - `created_at`: 生成时间
  - `source`（可选）

记忆会按 `content` 去重追加。

---

## 4. `search_memory` 工具

MaxAgent 默认注册了 `search_memory` 工具，供模型在需要回忆历史时检索长期记忆。

工具参数：

- `query`（string, required）：查询语句
- `top_k`（int, optional, default=5）：返回条数

返回：按相关度排序的记忆列表（markdown）。

示例（模型内部调用）：

```json
{"tool": "search_memory", "arguments": {"query": "GPU 选型", "top_k": 3}}
```

---

## 5. 自动记忆注入（无需模型主动调用）

除了提供 `search_memory` 工具外，MaxAgent 还会在每次调用 LLM 前自动检索与当前用户问题相关的记忆卡片，并注入到 prompt 中。

实现逻辑：

1. 在 `Agent.run()` / `Agent._continue_conversation()` 每次调用模型前执行 `_inject_relevant_memories()`。
2. 使用“最新一条 user 消息”作为查询语句，调用 `MemoryStore.search()` 获取 top_k 条相关记忆。
3. 生成一个 `assistant` 消息块（`name=memory_context`，标题 `## Relevant Memories`），插入到该 user 消息之前，保证最终 prompt 的最后一条仍为 user 角色。
4. 旧的 `memory_context` 会被移除，避免 prompt 无限增长。

检索算法：在关键词匹配基础上，对中文 query 自动生成 2-4 字 ngram，提升召回率（见 `src/maxagent/utils/context_summary.py`）。

---

## 6. 配置与注意事项

目前汇总和记忆注入功能使用内置默认参数，可通过 `ContextManager` 初始化参数调整：
---

## 5. 配置与注意事项

目前汇总功能使用内置默认参数，可通过 `ContextManager` 初始化参数调整：

- `compression_threshold`：触发比例（默认 0.8）
- `retained_ratio`：压缩后保留比例（默认 0.6）
- `summary_max_tokens`：摘要预算（默认 1200 tokens）
- `min_messages_to_keep`：最少保留最近消息数
- `enable_memory_injection`：是否自动注入记忆（默认 True）
- `memory_top_k`：每轮检索条数（默认 5）
- `memory_max_tokens`：注入块预算（默认 800 tokens）

注意：

- 触发汇总时会额外调用一次 LLM（超长对话会分块多次调用）
- 如果模型返回的 JSON 不合法，会退化为直接使用模型输出作为摘要
- 自动记忆注入不会额外调用模型，只读取本地 `memory.json`。
