# MaxAgent 技术架构文档

## 1. 项目概述

**项目名称**: MaxAgent - 基于多 LLM Provider 的 CLI 代码助手

**目标**: 提供一个类似 Claude Code / Copilot CLI 的本地命令行工具，支持多种 LLM Provider（GLM、OpenAI、GitHub Copilot 等），具备智能编程辅助能力。

**核心特性**:
- 🤖 多 Provider 支持: GLM (智谱)、OpenAI、GitHub Copilot、DeepSeek 等
- 🛠️ 丰富的工具系统: 文件操作、代码搜索、Git 集成、Web 抓取、MCP 协议
- 🧩 SubAgent 委派: 支持专业化子代理处理复杂任务
- 🧠 Deep Thinking: 支持 GLM/DeepSeek thinking 模型
- 📊 上下文管理: 滚动摘要 + 长期记忆卡片
- 🔧 Plan-Execute 工作流: 结构化任务规划与执行

---

## 2. 技术选型决策

### 2.1 开发语言: Python

| 候选方案 | 优点 | 缺点 | 结论 |
|---------|------|------|------|
| **Python** | 生态丰富、LiteLLM 原生支持、开发速度快、AI/ML 工具链完善 | 冷启动稍慢 | **选择** |
| Go | 启动快、单二进制部署 | LiteLLM 无 Go SDK、需额外 HTTP 封装 | 不选 |
| Node.js | 生态丰富 | 依赖管理复杂、类型安全较弱 | 不选 |

### 2.2 CLI 框架: Typer + Rich

| 候选方案 | 优点 | 缺点 | 结论 |
|---------|------|------|------|
| **Typer** | 类型提示定义参数、自动补全、Rich 集成 | 依赖 Click | **选择** |
| Click | 成熟稳定、功能全面 | 代码量较多 | 备选 |
| argparse | 零依赖 | 开发体验差 | 不选 |

### 2.3 Agent 框架: 原生实现

| 候选方案 | 优点 | 缺点 | 结论 |
|---------|------|------|------|
| **原生实现** | 最轻量、最快冷启动、完全可控 | 开发量较大 | **选择** |
| LangChain | 快速开发 | 依赖重、启动慢 | 不选 |
| LangGraph | 状态管理好 | 学习曲线陡峭 | 不选 |
| CrewAI | 角色概念直观 | 包体积大 | 不选 |

**原因**: CLI 工具对冷启动速度要求高，原生实现可保持 <0.5s 启动时间。

### 2.4 LLM 接入: 多 Provider 架构

MaxAgent 采用多 Provider 架构，支持直接对接多种 LLM 服务：

**支持的 Provider**:
- **GLM (智谱)**: 通过 `GLM_API_KEY` 或 `ZHIPU_KEY` 配置
- **OpenAI**: 通过 `OPENAI_API_KEY` 配置
- **GitHub Copilot**: OAuth Device Flow 认证
- **DeepSeek**: 支持 deepseek-chat 和 deepseek-reasoner
- **LiteLLM Proxy**: 可选的统一网关层

**Provider 优先级**（自动检测）:
```
GLM_API_KEY/ZHIPU_KEY > OPENAI_API_KEY > LITELLM_API_KEY > GITHUB_COPILOT
```

**显式覆盖**:
- `LLC_PROVIDER` / `MAXAGENT_PROVIDER`: 强制指定 provider
- `LLC_MODEL` / `MAXAGENT_MODEL`: 强制指定模型

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户终端                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      CLI 层 (Typer + Rich)                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │  chat   │ │  edit   │ │  task   │ │  test   │ │   mcp   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐                                        │
│  │  auth   │ │ config  │                                        │
│  └─────────┘ └─────────┘                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Agent Orchestrator                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Architect   │  │    Coder     │  │   Tester     │          │
│  │    Agent     │  │    Agent     │  │    Agent     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     Tool Registry                          │  │
│  │  read_file | write_file | edit | search_code | grep | glob │  │
│  │  run_command | git | webfetch | subagent | todo | memory   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Context Manager                          │  │
│  │     Token Tracking | Auto-Compress | Memory Injection      │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      LLM Client Layer                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 LLMClient / CopilotLLMClient             │    │
│  │  - OpenAI 兼容 API                                       │    │
│  │  - Tool Calling 支持                                     │    │
│  │  - Streaming 支持                                        │    │
│  │  - Thinking 内容处理                                     │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          ▼                     ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  GLM (智谱)    │     │GitHub Copilot │     │    OpenAI     │
│   DeepSeek    │     │  (OAuth)      │     │   Anthropic   │
└───────────────┘     └───────────────┘     └───────────────┘
```

### 3.2 分层架构说明

#### Layer 1: CLI 层
- **职责**: 用户交互、命令解析、终端渲染
- **技术**: Typer (命令解析) + Rich (终端 UI)
- **组件**:
  - `chat`: 通用对话/代码问答 (含 thinking 支持、Pipe 模式)
  - `edit`: 文件级修改
  - `task`: 需求级任务执行 (多 Agent 协作)
  - `test`: 测试框架检测、运行测试、AI 生成测试
  - `mcp`: MCP 服务器管理 (add/remove/list/test)
  - `auth`: 认证管理 (GitHub Copilot OAuth)
  - `config`: 配置管理

#### Layer 2: Agent Orchestrator
- **职责**: Agent 编排、任务分解、工具调用、上下文管理
- **组件**:
  - **Architect Agent**: 需求分析、任务拆解
  - **Coder Agent**: 代码生成、Patch 创建
  - **Tester Agent**: 测试生成、结果分析
  - **Tool Registry**: 工具注册和调用 (支持 MCP 扩展)
  - **Context Manager**: Token 统计、自动压缩、记忆注入

#### Layer 3: LLM Client
- **职责**: LLM API 调用、Token 管理、流式输出、Thinking 处理
- **组件**:
  - **LLMClient**: 通用 OpenAI 兼容客户端
  - **CopilotLLMClient**: GitHub Copilot 专用客户端 (OAuth 认证)

#### Layer 4: LLM Providers
- **GLM (智谱)**: 默认 Provider，支持 thinking 模型
- **OpenAI**: GPT-4/4o 系列
- **GitHub Copilot**: OAuth 认证，支持 claude-3.5-sonnet、o1 等模型
- **DeepSeek**: 支持 deepseek-chat 和 deepseek-reasoner

---

## 4. 核心模块设计

### 4.1 多 Provider 支持

```python
# 配置优先级链
# 环境变量 -> 项目配置 -> 用户配置 -> 默认值

# Provider 自动检测优先级
GLM_API_KEY/ZHIPU_KEY > OPENAI_API_KEY > LITELLM_API_KEY > GITHUB_COPILOT

# 显式覆盖
LLC_PROVIDER=glm  # 强制使用 GLM
LLC_MODEL=gpt-4o  # 强制使用指定模型
```

**配置文件示例** (.llc.yaml):
```yaml
litellm:
  provider: glm
  base_url: https://open.bigmodel.cn/api/coding/paas/v4

model:
  default: glm-4.6
  temperature: 0.7
  max_tokens: 4096
  context_length: 128000
  # 模型特定配置
  models:
    gpt-4o:
      max_tokens: 8192
      context_length: 128000
    github_copilot/gpt-4o:  # Provider 特定配置
      max_tokens: 4096
      context_length: 100000
```

### 4.2 Tool 系统设计

```python
# OpenAI-style Tool Schema
tools = [
    {
        "type": "function",
        "function": {
            "name": "read_file",
            "description": "读取指定文件内容",
            "parameters": {
                "type": "object",
                "properties": {
                    "path": {
                        "type": "string",
                        "description": "文件路径"
                    }
                },
                "required": ["path"]
            }
        }
    }
]
```

**支持的 Tools**:

| Tool | 功能 | 安全级别 |
|------|------|---------|
| `read_file` | 读取文件内容 | 低风险 |
| `list_files` | 按 glob 匹配文件 | 低风险 |
| `search_code` | 代码搜索 | 低风险 |
| `grep` | 正则搜索 (支持 ripgrep) | 低风险 |
| `glob` | 文件模式匹配 | 低风险 |
| `find_files` | 文件查找 | 低风险 |
| `edit` | Search-Replace 精确修改 | 中风险 |
| `write_file` | 写入文件 (推荐仅用于新文件) | 高风险 |
| `run_command` | 执行命令 | 高风险 |
| `git_status` | 获取 Git 状态 | 低风险 |
| `git_diff` | 获取 Git 差异 | 低风险 |
| `git_log` | 获取 Git 日志 | 低风险 |
| `git_branch` | 获取 Git 分支 | 低风险 |
| `webfetch` | 抓取网页内容 | 低风险 |
| `subagent` | 启动专用子代理 | 中风险 |
| `task` | 自主任务执行 | 中风险 |
| `todowrite` | 创建/管理待办列表 | 低风险 |
| `todoread` | 读取待办列表 | 低风险 |
| `todoclear` | 清除待办列表 | 低风险 |
| `search_memory` | 搜索长期记忆 | 低风险 |

### 4.3 SubAgent 系统

```
┌─────────────────────────────────────────────────────────────────┐
│                     SubAgent 类型                                │
├─────────────────────────────────────────────────────────────────┤
│  explore   - 快速代码库探索，支持批量并行搜索                      │
│  architect - 需求分析与方案设计                                  │
│  coder     - 代码生成与修改                                      │
│  tester    - 测试生成与分析                                      │
│  shell     - CLI 环境操作（安装依赖、运行服务器等）                │
│  general   - 通用任务处理                                        │
└─────────────────────────────────────────────────────────────────┘
```

使用示例：
```python
# 在对话中委派子代理
subagent(agent_type="explore", task="查找所有使用 Redis 的代码")
subagent(agent_type="shell", task="安装 pytest 并运行测试")
```

### 4.4 Agent 编排模式

```
┌─────────────────────────────────────────────────────────────┐
│                      Task 命令流程                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   用户输入    │
                    │   需求描述    │
                    └───────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Architect Agent                           │
│  - 分析需求                                                  │
│  - 调用 list_files/search_code 了解项目结构                  │
│  - 输出: 任务分解 + 修改方案                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Coder Agent                             │
│  - 按 Architect 方案执行                                     │
│  - 调用 read_file 获取文件内容                               │
│  - 生成 unified diff patch                                   │
│  - 输出: patch 列表                                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     Tester Agent (可选)                      │
│  - 为变更生成测试代码                                        │
│  - 调用 run_command 执行测试                                 │
│  - 分析测试结果                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   用户确认    │
                    │   应用 Patch  │
                    └───────────────┘
```

---

## 5. 配置系统

### 5.1 配置文件层级

```
优先级 (高 → 低):
1. 命令行参数
2. 环境变量
3. 项目配置: ./.llc.yaml
4. 用户配置: ~/.llc/config.yaml
5. 默认值
```

### 5.2 配置文件结构

```yaml
# ~/.llc/config.yaml 或 .llc.yaml
litellm:
  provider: glm                              # API Provider: glm/openai/github_copilot
  base_url: "https://open.bigmodel.cn/api/coding/paas/v4"
  api_key: "${GLM_API_KEY}"                  # 支持环境变量

model:
  default: "glm-4.6"
  thinking_model: "glm-4.6"                  # Thinking 模型
  thinking_strategy: "auto"                  # auto/enabled/disabled
  show_thinking: true
  temperature: 0.7
  max_tokens: 4096
  context_length: 128000
  max_iterations: 100                        # 最大工具调用次数
  parallel_tool_calls: true                  # 并行工具调用
  enable_tool_planner: false                 # Agent 侧工具规划
  # 模型特定配置
  models:
    gpt-4o:
      max_tokens: 8192
      context_length: 128000
    deepseek-chat:
      temperature: 0.5
    github_copilot/gpt-4o:                   # Provider 特定配置
      max_tokens: 4096

tools:
  enabled:
    - read_file
    - list_files
    - write_file
    - edit
    - search_code
    - grep
    - glob
    - find_files
    - run_command
    - git_status
    - git_diff
    - git_log
    - git_branch
    - webfetch
    - todowrite
    - todoread
    - todoclear
    - search_memory
  disabled: []                               # 按需禁用工具

security:
  ignore_patterns:
    - ".env"
    - "*.pem"
    - "*.key"
  require_confirmation:
    - write_file
    - run_command
```

---

## 6. 安全设计

### 6.1 敏感文件保护

```python
DEFAULT_IGNORE_PATTERNS = [
    ".env", ".env.*",
    "*.pem", "*.key", "*.p12",
    "**/secrets/**",
    "**/credentials/**",
    ".git/config",  # 可能包含 token
]
```

### 6.2 命令执行沙箱

```python
class CommandExecutor:
    def __init__(self, config: Config):
        self.timeout = config.command_timeout  # 默认 30s
        self.whitelist = config.command_whitelist
        self.require_confirmation = config.require_command_confirmation
    
    async def execute(self, cmd: str, cwd: str) -> CommandResult:
        # 1. 白名单检查
        if not self._is_whitelisted(cmd):
            if self.require_confirmation:
                if not await self._confirm_execution(cmd):
                    raise ExecutionDenied()
        
        # 2. 执行命令 (带超时)
        # 3. 输出截断 (防止 token 浪费)
```

### 6.3 Patch 应用安全

```python
class PatchApplier:
    def apply(self, patch: str, target_file: str) -> ApplyResult:
        # 1. 创建备份
        backup_path = self._create_backup(target_file)
        
        # 2. 验证 patch 格式
        if not self._validate_patch(patch):
            raise InvalidPatch()
        
        # 3. 应用 patch
        try:
            result = self._apply_unified_diff(patch, target_file)
            return ApplyResult(success=True, backup=backup_path)
        except Exception as e:
            # 4. 失败时恢复
            self._restore_from_backup(backup_path, target_file)
            raise
```

---

## 7. 性能优化

### 7.1 冷启动优化

| 策略 | 说明 |
|------|------|
| 延迟导入 | 非必要模块延迟加载 |
| 精简依赖 | 仅引入必要包 |
| 编译缓存 | 使用 `__pycache__` |
| 原生实现 | 避免重框架 |

**目标**: 冷启动 < 500ms

### 7.2 Token 优化

| 策略 | 说明 |
|------|------|
| 上下文合并 | 一次请求处理多个 Tool Calls |
| 输出截断 | 命令输出限制长度 |
| 增量上下文 | 仅传递必要文件内容 |
| 缓存机制 | 缓存项目结构信息 |
| 滚动摘要 | 自动压缩长对话历史 |
| 记忆注入 | 相关长期记忆自动注入 |

### 7.3 流式输出

```python
async def stream_response(response):
    """实时流式输出 LLM 响应"""
    async for chunk in response:
        if chunk.choices[0].delta.content:
            console.print(chunk.choices[0].delta.content, end="")
```

---

## 8. 技术栈总结

| 层级 | 技术 | 版本要求 |
|------|------|---------|
| 语言 | Python | >= 3.12 |
| CLI | Typer | >= 0.9 |
| 终端 UI | Rich | >= 13.0 |
| HTTP | httpx | >= 0.25 |
| 配置 | PyYAML | >= 6.0 |
| 验证 | Pydantic | >= 2.0 |
| 异步 | anyio | >= 4.0 |

---

## 9. 已实现功能

### 9.1 CLI 命令
- `mcode chat` - 对话命令 (含 thinking 支持、Pipe 模式、REPL 模式)
- `mcode edit` - 文件编辑
- `mcode task` - 复杂任务 (多 Agent 协作)
- `mcode test` - 测试框架检测/运行/AI 生成测试
- `mcode auth` - 认证管理 (GitHub Copilot OAuth)
- `mcode mcp` - MCP 服务器管理
- `mcode config` - 配置管理

### 9.2 支持的 LLM Provider
- GLM (智谱) - `GLM_API_KEY` / `ZHIPU_KEY`
- OpenAI - `OPENAI_API_KEY`
- GitHub Copilot - OAuth 认证
- DeepSeek - `deepseek-chat`, `deepseek-reasoner`
- LiteLLM Proxy (可选网关)

### 9.3 Thinking 模型支持
- GLM: glm-4.6 (`<think>` 标签格式)
- DeepSeek: deepseek-reasoner, deepseek-r1 (`reasoning_content` 字段)

### 9.4 Test 命令功能
- 测试框架检测 (pytest, unittest, jest, vitest, mocha, go test, cargo test)
- 测试执行 (支持 coverage, watch 模式)
- AI 测试生成 (使用 TesterAgent)

### 9.5 单元测试
- 测试框架: pytest + pytest-asyncio + pytest-cov
- 测试文件:
  - `tests/test_thinking_strategy.py` - Thinking 策略测试
  - `tests/test_test_cmd.py` - 测试命令测试
  - `tests/test_config_loader.py` - 配置加载测试
  - `tests/test_tools_base.py` - 工具基类测试
  - `tests/test_tokens.py` - Token 统计测试
  - `tests/test_github_copilot.py` - GitHub Copilot 认证测试
  - `tests/test_mcp.py` - MCP 模块测试 (含连接状态测试)
  - `tests/test_edit.py` - Edit 工具测试 (Replacer 策略)
  - `tests/test_todo.py` - Todo 工具测试
  - `tests/test_context.py` - 上下文管理测试
  - `tests/test_model_specific_config.py` - 模型特定配置测试

### 9.6 MCP (Model Context Protocol) 集成
- HTTP 传输: Streamable HTTP + JSON-RPC 2.0
- Stdio 传输: 子进程 stdin/stdout 通信
- 支持智谱 GLM web_reader 等远程 MCP 服务器
- 支持本地 MCP 服务器 (如 mcp-searxng)
- 工具自动注册到 Agent 工具系统

### 9.7 高级功能
- **SubAgent 委派**: explore/architect/coder/tester/shell/general
- **Todo 工具**: 结构化任务列表管理
- **Plan-Execute 工作流**: 复杂任务的规划与执行
- **上下文管理**: 滚动摘要 + 长期记忆卡片
- **记忆注入**: 自动检索相关历史记忆
- **模型特定配置**: 按模型/Provider 配置参数
- **批量编辑**: edit 工具支持 edits 数组参数

---

## 10. MCP 架构设计

### 10.1 MCP 概述

MCP (Model Context Protocol) 是 Anthropic 推出的模型上下文协议，
允许 AI 模型通过标准化接口访问外部工具和数据源。

MaxAgent 实现了完整的 MCP 客户端支持，包括两种传输方式：

### 10.2 传输类型

```
┌─────────────────────────────────────────────────────────────────┐
│                      MCP 传输架构                                │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────┐         ┌──────────────────────┐
│   HTTP 传输           │         │   Stdio 传输          │
│  (远程 MCP 服务器)     │         │  (本地 MCP 服务器)     │
├──────────────────────┤         ├──────────────────────┤
│  • JSON-RPC 2.0      │         │  • JSON-RPC 2.0      │
│  • Streamable HTTP   │         │  • stdin/stdout      │
│  • SSE 响应支持       │         │  • 子进程管理         │
│  • Session 管理       │         │  • 环境变量传递       │
└──────────────────────┘         └──────────────────────┘
          │                               │
          └───────────┬───────────────────┘
                      │
                      ▼
         ┌──────────────────────┐
         │   MCPClientBase      │
         │   (抽象基类)          │
         ├──────────────────────┤
         │  • connect()         │
         │  • list_tools()      │
         │  • call_tool()       │
         │  • close()           │
         └──────────────────────┘
                      │
                      ▼
         ┌──────────────────────┐
         │  create_mcp_client() │
         │     (工厂函数)        │
         └──────────────────────┘
```

### 10.3 MCP 模块结构

```
src/maxagent/mcp/
├── __init__.py         # 模块导出
├── config.py           # 配置管理
│   ├── MCPServerConfig   # 服务器配置类
│   └── MCPConfig         # 配置容器
├── client.py           # MCP 客户端
│   ├── MCPClientBase     # 抽象基类
│   ├── MCPHttpClient     # HTTP 传输客户端
│   ├── MCPStdioClient    # Stdio 传输客户端
│   └── create_mcp_client # 工厂函数
└── tools.py            # 工具集成
    ├── MCPTool           # BaseTool 包装类
    └── MCPToolRegistry   # MCP 工具注册表
```

### 10.4 工具集成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    MCP 工具集成流程                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  加载 MCP 配置   │
                    │  MCPConfig.load │
                    └─────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │  遍历启用的 MCP 服务器         │
              └───────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │ HTTP 服务器  │     │ Stdio 服务器 │     │    ...     │
   └─────────────┘     └─────────────┘     └─────────────┘
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │ MCPHttpClient│    │MCPStdioClient│    │    ...     │
   └─────────────┘     └─────────────┘     └─────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   list_tools()  │
                    │   获取工具定义   │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   MCPTool 包装   │
                    │  转换为 BaseTool │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 注册到 Agent    │
                    │  ToolRegistry   │
                    └─────────────────┘
```

### 10.5 使用示例

#### HTTP 传输 (智谱 GLM web_reader)

```bash
# 添加服务器
mcode mcp add web-reader https://open.bigmodel.cn/api/mcp/web_reader/mcp \
    --header "Authorization: Bearer ${ZHIPU_KEY}"

# 测试连接
mcode mcp test web-reader

# 在对话中使用
mcode chat "Use web-reader to fetch https://example.com"
```

#### Stdio 传输 (本地 mcp-searxng)

```bash
# 安装 MCP 服务器
pip install mcp-searxng

# 添加服务器
mcode mcp add searxng --command mcp-searxng \
    --env "SEARXNG_URL=http://192.168.31.205:8888"

# Claude 兼容语法 (使用 -- 分隔符)
mcode mcp add searxng --transport stdio -- env SEARXNG_URL=http://192.168.31.205:8888 mcp-searxng

# 测试连接
mcode mcp test searxng

# 在对话中使用
mcode chat "Search for Python tutorials"
```

#### 列出服务器和连接状态

```bash
# 列出所有服务器并自动测试连接状态
mcode mcp list

# 输出示例:
# Testing server connections...
#
#                                   MCP Servers                                   
# ┏━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━┓
# ┃ Name       ┃ Type  ┃ URL/Command    ┃ Status  ┃ Connection   ┃
# ┡━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━┩
# │ web-reader │ http  │ https://open.… │ Enabled │ OK (1 tools) │
# │ searxng    │ stdio │ mcp-searxng    │ Enabled │ OK (2 tools) │
# └────────────┴───────┴────────────────┴─────────┴──────────────┘

# 详细模式显示环境变量和错误信息
mcode mcp list -v

# 跳过连接测试快速列出
mcode mcp list --no-test
```

---

## 11. Edit 工具架构设计

### 11.1 设计背景

传统的 `write_file` 工具会重写整个文件，导致以下问题：
- LLM 可能遗漏原有代码（如 calculator.py 的 add/subtract 被覆盖）
- 大文件修改效率低下
- 不便于审查变更

**解决方案**: 采用 Search-and-Replace 模式，参考 Claude Code 的 `str_replace` 和 OpenCode 的 edit.ts。

### 11.2 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      Edit 工具架构                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         EditTool                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  参数: file_path, old_string, new_string, replace_all   │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    replace_content()                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              9 种 Replacer 策略 (按优先级)               │    │
│  │  ┌─────────────────────────────────────────────────────┐│    │
│  │  │ 1. simple_replacer        - 精确匹配               ││    │
│  │  │ 2. line_trimmed_replacer  - 行首尾空白修剪         ││    │
│  │  │ 3. block_anchor_replacer  - 块锚点 + Levenshtein   ││    │
│  │  │ 4. whitespace_normalized  - 空白标准化             ││    │
│  │  │ 5. indentation_flexible   - 缩进灵活               ││    │
│  │  │ 6. escape_normalized      - 转义字符               ││    │
│  │  │ 7. trimmed_boundary       - 边界修剪               ││    │
│  │  │ 8. context_aware          - 上下文感知             ││    │
│  │  │ 9. multi_occurrence       - 多次出现               ││    │
│  │  └─────────────────────────────────────────────────────┘│    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   create_unified_diff()                          │
│                   生成差异输出供用户审查                          │
└─────────────────────────────────────────────────────────────────┘
```

### 11.3 Replacer 策略链

```python
REPLACERS = [
    simple_replacer,              # 最严格: 精确匹配
    line_trimmed_replacer,        # 宽松: 行首尾空白
    block_anchor_replacer,        # 智能: 锚点 + 相似度
    whitespace_normalized_replacer,
    indentation_flexible_replacer,
    escape_normalized_replacer,
    trimmed_boundary_replacer,
    context_aware_replacer,
    multi_occurrence_replacer,    # 最宽松: 选择最佳匹配
]
```

### 11.4 Levenshtein 距离

用于 `block_anchor_replacer` 计算字符串相似度：

```python
def levenshtein_distance(s1: str, s2: str) -> int:
    """
    计算两个字符串的编辑距离
    时间复杂度: O(m*n)
    空间复杂度: O(n) - 使用滚动数组优化
    """
    if len(s1) < len(s2):
        s1, s2 = s2, s1
    
    prev_row = list(range(len(s2) + 1))
    for i, c1 in enumerate(s1):
        curr_row = [i + 1]
        for j, c2 in enumerate(s2):
            cost = 0 if c1 == c2 else 1
            curr_row.append(min(
                prev_row[j + 1] + 1,      # 删除
                curr_row[j] + 1,          # 插入
                prev_row[j] + cost        # 替换
            ))
        prev_row = curr_row
    return prev_row[-1]
```

### 11.5 与提示词系统集成

Edit 工具通过 `TOOL_USAGE_POLICY` 集成到 Agent 提示词：

```markdown
## Editing Files - IMPORTANT

When modifying existing files, ALWAYS use the `edit` tool instead of `write_file`:

- `edit`: Search-and-replace for precise modifications (PREFERRED)
- `write_file`: Only for creating NEW files

### Edit Tool Usage:
1. FIRST read the file with `read_file` to see current content
2. Use `edit` with exact `old_string` matching the current content
3. The `new_string` contains your modifications
```

### 11.6 工具流程

```
用户请求修改文件
        │
        ▼
┌───────────────────┐
│  1. read_file     │  ← LLM 必须先读取文件
│     获取内容       │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  2. edit 工具      │
│  - old_string     │  ← 精确匹配现有内容
│  - new_string     │  ← 替换后的新内容
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  3. 返回 diff     │  ← unified diff 格式
│     供用户审查     │
└───────────────────┘
```

---

## 12. 下一步开发计划

详见 TODO.md
